---
title: ğŸš©ìµœì¢… í”„ë¡œì íŠ¸ - S3ë¥¼ ì´ìš©í•œ íŒŒì¼(ì´ë¯¸ì§€) ì—…ë¡œë“œ
author: LeeNaYoung
date:   2024-07-25 21:46:06 +09:00
categories: [study]
tags: [study]
---




# AWS S3ë¥¼ ì´ìš©í•œ íŒŒì¼(ì´ë¯¸ì§€)  ì—…ë¡œë“œ


- **S3 : Simple Storage Service ì˜ ì•½ìë¡œ ì£¼ë¡œ íŒŒì¼ ì„œë²„ë¡œ ì‚¬ìš©ë¨.**

- êµ¬ê¸€ ë“œë¼ì´ë¸Œì²˜ëŸ¼ íŒŒì¼ ì €ì¥ ì„œë¹„ìŠ¤ì´ë©°, ë°ì´í„°ë¥¼ ì˜¨ë¼ì¸ ì˜¤ë¸Œì íŠ¸ í˜•íƒœë¡œ ì €ì¥í•˜ëŠ” ì„œë¹„ìŠ¤ë¼ê³  ë³´ë©´ ë¨!

- **ì™œ S3ë¥¼ ì‚¬ìš©í•´ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í•˜ëŠ”ê°€?**

	- S3 ìì²´ë¡œ ì •ì  ì›¹ ì„œë¹„ìŠ¤ ê°€ëŠ¥
	- S3ëŠ” ì €ì¥ ìš©ëŸ‰ì´ ë¬´í•œëŒ€ì´ê³  íŒŒì¼ ì €ì¥ì— ìµœì í™”ë˜ì–´ ìˆë‹¤. ìš©ëŸ‰ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì„±ëŠ¥ì„ ë†’ì´ëŠ” ì‘ì—…ì´ í•„ìš”ì—†ìŒ.
	- í™•ì¥ì„± : íŒŒì¼ ì„œë²„ëŠ” íŠ¸ë˜í”½ì´ ì¦ê°€í•¨ì— ë”°ë¼ ì„œë²„ ì¸í”„ë¼ ë° ìš©ëŸ‰ ê³„íšì„ ë³€ê²½í•´ì•¼ ë˜ëŠ”ë° S3ê°€ í™•ì¥ ë° ì„±ëŠ¥ ë¶€ë¶„ì„ ëŒ€ì‹  ì²˜ë¦¬í•´ì¤Œ.

	- ë‚´êµ¬ì„± : ì—¬ëŸ¬ ì˜ì—­ì— ì—¬ëŸ¬ ë°ì´í„° ë³µì‚¬ë³¸ì„ ì €ì¥í•˜ë¯€ë¡œ í•œ ì˜ì—­ì´ ë‹¤ìš´ë˜ë”ë¼ë„ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê³  ë³µêµ¬ê°€ ê°€ëŠ¥í•¨.

	- ê²°ë¡  : S3ëŠ” ì €ì¥í•˜ëŠ” ë°ì´í„° ì–‘ì— ëŒ€í•œ ë¹„ìš©ë„ ì €ë ´í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆëŠ” ë°ì´í„° ì–‘ì´ ë¬´í•œì— ê°€ê¹Œì›€. ë˜í•œ 'elastic' í•œ ì„±ì§ˆ ë•Œë¬¸ì— ë³„ë„ì˜ ìŠ¤í† ë¦¬ì§€ í™•ì¥, ì¶•ì†Œì— ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ë¨.  FTP ì„œë²„ì²˜ëŸ¼ ë‹¨ìˆœí•œ íŒŒì¼ ì €ì¥ ì˜ì—­ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìœ¼ë©°, ë‹¤ì–‘í•œ AWS ì„œë¹„ìŠ¤ì˜ ì‚¬ìš© ë¡œê·¸ ì €ì¥, ì •ì  ì›¹ ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ…, EBS ìŠ¤ëƒ…ìƒ·ì˜ ì €ì¥ ì˜ì—­ ê¸°ëŠ¥ ë“±ì„ ê°€ì§€ê³  ìˆìŒ.

	
	- í•˜ì§€ë§Œ S3ëŠ” íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ, ì—…ë°ì´íŠ¸ë§Œ ê°€ëŠ¥í•˜ê³  í”„ë¡œê·¸ë¨ì„ ì„¤ì¹˜í•´ì„œ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì€ ì—†ìŒ.

- **S3 ê´€ë ¨ ìš©ì–´**

	- ê°ì²´(Object) : íŒŒì¼ê³¼ íŒŒì¼ ì •ë³´ë¡œ êµ¬ì„±ëœ ì €ì¥ ë‹¨ìœ„ë¡œ íŒŒì¼ì´ë¼ê³  ìƒê°í•˜ë©´ ë¨!
	
		- S3ì— ì €ì¥ë˜ëŠ” ë°ì´í„°ëŠ” ëª¨ë‘ ê°ì²´ë¼ê³  ë¶€ë¦„

		- ê° ê°ì²´ëŠ” ë°ì´í„°ì™€ ë©”íƒ€ë°ì´í„°ë¥¼ ì§€ë‹ˆëŠ”ë° S3 ë²„í‚·ì— ì˜¬ë¦¬ëŠ” ê°ì²´ê°€ ë°”ë¡œ ë°ì´í„°ì´ê³   **ìµœì¢… ìˆ˜ì •ì¼, íŒŒì¼ íƒ€ì… ë“±ì˜ ë°ì´í„°ë¥¼ ë©”íƒ€ë°ì´í„°**ë¼ê³  í•¨. (ë©”íƒ€ë°ì´í„°ëŠ” ë„¤ì„-ë²¨ë¥˜ ìŒìœ¼ë¡œ ì´ìš°ëŸ¬ì ¸ ìˆë‹¤.)

		- ê°ì²´ëŠ”  **í‚¤**ë¥¼ í†µí•´ì„œ ë²„í‚·ì—ì„œ ìœ ì¼í•œ ê²ƒìœ¼ë¡œ ì‹ë³„ë  ìˆ˜ ìˆìœ¼ë©°, ë²„í‚·ì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ê°ì²´ëŠ” ë‹¨ í•˜ë‚˜ì˜ í‚¤ë¥¼ ì§€ë‹Œë‹¤.

		= ë”°ë¼ì„œ **S3 ë‚´ì—ì„œ ë²„í‚·, í‚¤, ë²„ì „ IDë¥¼ í†µí•´ íŠ¹ì • ê°ì²´ë¥¼ íŒŒì•…**í•  ìˆ˜ ìˆë‹¤.

		
	- ë²„í‚·(Bucket) : ë‹¤ìˆ˜ì˜ ê°ì²´ë¥¼ ê´€ë¦¬í•˜ëŠ” ì»¨í…Œì´ë„ˆë¡œ íŒŒì¼ ì‹œìŠ¤í…œì´ë¼ê³  ë³´ë©´ ë¨!

		- ë§Œì•½ Nayoung(ë²„í‚· ì´ë¦„)ì´ë¼ëŠ” ì´ë¦„ì˜ ë²„í‚·ì— test.png ê°ì²´ íŒŒì¼ì„ ì €ì¥í•˜ë©´ http://Nayoung.s3.amazonaws.com/test.png ë¼ëŠ” URLì´ ìƒì„±ë˜ê²Œ ë¨.

		 - S3ì„ êµ¬ì„±í• ë•Œ,  **ë²„í‚·(Bucket)**ì´ë¼ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ë†“ì„  **ë¦¬ì „ì„ ì„ íƒ**í•˜ê³ , í•´ë‹¹ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—  **ê°ì²´(Object)**ë¼ëŠ” í˜•íƒœë¡œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” í˜•íƒœë¡œ ìŠ¤í† ë¦¬ì§€ë¥¼ êµ¬ì¶•í•¨.

		- í•œ ê³„ì • ë‹¹ Bucketì€ ìµœëŒ€ 100ê°œê¹Œì§€ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ê³ , ë²„í‚· ë‹¨ìœ„ë¡œ ì ‘ê·¼ ì œí•œì„ ì„¤ì •í•  ìˆ˜ë„ ìˆë‹¤.

		- ë‹¨, Bucketì˜ ì†Œìœ ê¶Œì€ ì´ì „í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì£¼ì˜í•´ì•¼ í•œë‹¤.


- **S3 ì‚¬ìš© ì˜ˆì‹œ**
	- í´ë¼ìš°ë“œ ì €ì¥ì†Œ - êµ¬ê¸€ ë“œë¼ì´ë¸Œì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥
	
	- ì„œë¹„ìŠ¤ì˜ ëŒ€ìš©ëŸ‰ íŒŒì¼ ì €ì¥ì†Œ - ì´ë¯¸ì§€, ë™ì˜ìƒ, ë¹…ë°ì´í„°
	- ì„œë¹„ìŠ¤ ë¡œê·¸ ì €ì¥ ë° ë¶„ì„
	- ì„œë¹„ìŠ¤ ì‚¬ìš©ìì˜ ë°ì´í„° ì—…ë¡œë“œ ì„œë²„
	- ì¤‘ìš”í•œ íŒŒì¼ì€ EC2ì˜ SSDì— ì €ì¥í•˜ì§€ ë§ê³  S3ì— ì €ì¥

<br>

# AWS S3 ìƒì„±í•˜ê¸°

## 1. AWS ê°€ì…í•˜ê¸°

<br>

## 2. AWS Console > S3 > ë²„í‚· > ë²„í‚· ë§Œë“¤ê¸°

<a href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/2dbf5436-4498-4151-833d-c5d6fe6a3703" class="popup img-link"><img src="https://github.com/user-attachments/assets/2dbf5436-4498-4151-833d-c5d6fe6a3703" alt="1" loading="lazy"></a>

- ê²€ìƒ‰ ì°½ì— S3ë¼ê³  ì…ë ¥í•˜ë©´ ë¨

<a href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/44d2f599-ce4a-43f4-a11b-20b155dea6de" class="popup img-link"><img src="https://github.com/user-attachments/assets/44d2f599-ce4a-43f4-a11b-20b155dea6de" alt="1" loading="lazy"></a>

- í•´ë‹¹ ë²„í‚· ë§Œë“¤ê¸° ë²„íŠ¼ í´ë¦­

<a href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/1360d4df-7061-4fbe-8404-5a16db5b6708" class="popup img-link"><img src="https://github.com/user-attachments/assets/1360d4df-7061-4fbe-8404-5a16db5b6708" alt="1" loading="lazy"></a>

<a href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/c49f56e3-c65b-4da5-a126-55fd602c5ee7" class="popup img-link"><img src="https://github.com/user-attachments/assets/c49f56e3-c65b-4da5-a126-55fd602c5ee7" alt="1" loading="lazy"></a>

- AWS ë¦¬ì „ì´ "ì•„ì‹œì•„ íƒœí‰ì–‘(ì„œìš¸) ap-northeast-2ì¸ì§€ í™•ì¸

- ë²„í‚· ì´ë¦„ ì…ë ¥í•˜ê³  ì•¡ì„¸ìŠ¤ ì°¨ë‹¨ ì„¤ì •ì„ í•´ì œ
	- ì• í”Œë¦¬ì¼€ì´ì…˜ì€ íŒŒì¼ ì¡°ì‘ ê¶Œí•œì„ ê°–ê²Œ í•˜ê³  ê¶Œí•œ ë³€ê²½ í•„ìš” ì‹œì—ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ íŒŒì¼ ì¡°ì‘ ê¶Œí•œì€ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ê¶Œí•œ ì„¤ì •ìœ¼ë¡œ í•˜ë©´ ë¨.


<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/7bd7496a-04f9-49cc-beac-111cd0935cc6"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/7bd7496a-04f9-49cc-beac-111cd0935cc6"  alt="1"  loading="lazy"></a>

- ì›ë˜ ACLì„ ë¹„í™œì„±í™” í–ˆì—ˆëŠ”ë° ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ë¡œ ì¸í•´ í™œì„±í™”ë¡œ ë³€ê²½í•¨

<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/e06a07d9-06ac-463c-9304-1eb76d45006a"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/e06a07d9-06ac-463c-9304-1eb76d45006a"  alt="1"  loading="lazy"></a>

```java
 : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: 
 com.amazonaws.services.s3.model.AmazonS3Exception: The bucket does not allow ACLs (Service: Amazon S3; Status Code: 400; Error Code: 
 AccessControlListNotSupported; Request ID: CQP6Y0Z9A93YXA1W; S3 Extended Request ID: 
2NqX1W81AanB67RTBGMPwbJxsEDAIl9FnsYuVOv9qLQFieLv7sNYubR9WzP5zVmC+/bbGBPD+q8XNr9Tn385cQ==; Proxy: null), S3 Extended Request ID: 2NqX1W81AanB67RTBGMPwbJxsEDAIl9FnsYuVOv9qLQFieLv7sNYubR9WzP5zVmC+/bbGBPD+q8XNr9Tn385cQ==] with root cause
```

- ì´ ì˜¤ë¥˜ëŠ” Amazon S3 ë²„í‚·ì´ ì•¡ì„¸ìŠ¤ ì œì–´ ëª©ë¡(ACLs)ì„ ì§€ì›í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ë¬¸ì œ. ACL í™œì„±í™” í–ˆì§€ë§Œ ì¡°ê¸ˆ ë” ì°¾ì•„ë´ì•¼ ë  ë“¯!

- í•˜ì§€ë§Œ S3 ê³µê°œì„¤ì •ì€ S3ì— ì—…ë¡œë“œ ëœ íŒŒì¼ì„ íŒŒì¼ ì†Œìœ ìê°€ ì•„ë‹Œ ë‹¤ë¥¸ ì‚¬ëŒì´ ë³¼ ìˆ˜ ìˆì–´, ë°ì´í„° ìœ ì¶œì‚¬ê³  ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§.

â–¶ ë³´ì•ˆì‚¬ê³  ì‚¬ë¡€1:  [https://www.asiatime.co.kr/article/20220707500294](https://www.asiatime.co.kr/article/20220707500294)

â–¶ ë³´ì•ˆì‚¬ê³  ì‚¬ë¡€2:  [https://m.boannews.com/html/detail.html?mtype=1&idx=108196](https://m.boannews.com/html/detail.html?mtype=1&idx=108196)

AWSëŠ” S3 ê³µê°œì„¤ì •ìœ¼ë¡œ ë³´ì•ˆ ì‚¬ê³ ë¥¼ ì¤„ì´ê¸° ìœ„í•´.  **23ë…„ 4ì›”ë¶€í„° ìƒì„±í•œ S3ëŠ” ê³µê°œì„¤ì •ì„ ë¹„í—ˆìš©í•˜ê³  ACLë¥¼ ë¹„í™œì„±í™”**í–ˆìŒ.

- ê²°ë¡  : ë¹„í™œì„±í™”í•´ì„œ ì˜¤ë¥˜ë¥¼ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ìˆ˜ì •í•´ì•¼í•¨.

```java
multipartFiles.forEach(file -> {  
    String originalFilename = file.getOriginalFilename();  
    String fileName = createFileName(originalFilename);  
    String extension = getFileExtension(originalFilename);  
  
    ObjectMetadata objectMetadata = new ObjectMetadata();  
    validateFileSize(file.getSize(), extension);  
    objectMetadata.setContentLength(file.getSize());  
    objectMetadata.setContentType(file.getContentType());  
  
    try (InputStream inputStream = file.getInputStream()) {  
        amazonS3.putObject(new PutObjectRequest(bucket, fileName, inputStream, objectMetadata)  
                .withCannedAcl(CannedAccessControlList.PublicRead));  
    } catch (IOException e) {  
        throw new CustomException(ErrorCode.PUT_OBJECT_EXCEPTION);  
    }  
  
    String fileUrl = amazonS3.getUrl(bucket, fileName).toString();  
  
    // íŒŒì¼ ì •ë³´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥  
    File fileEntity = new File(fileName, fileUrl, file.getContentType(), file.getSize());  
    fileRepository.save(fileEntity);  
    // í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ê³  ë°˜í™˜
    fileEntities.add(fileEntity);  
});  
  
return fileEntities;
```

- í•´ë‹¹ ì½”ë“œì—ì„œ `.withCannedAcl(CannedAccessControlList.PublicRead))` í•´ë‹¹ ë¶€ë¶„ ì œê±°í•˜ì—¬ ì˜¤ë¥˜ í•´ê²°

- í•´ê²°í•œ ë°©ë²• : ì´ ì˜¤ë¥˜ëŠ” í˜„ì¬ S3 ë²„í‚·ì´ ACLì„ ì§€ì›í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ê²ƒìœ¼ë¡œ í•´ê²° ë°©ë²•ì€  ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ `CannedAccessControlList`ë¥¼ ì œê±°í•¨ìœ¼ë¡œì¨ S3 ë²„í‚·ì˜ ACL ë¹„í™œì„±í™” ì„¤ì •ê³¼ ì¼ì¹˜í•˜ê²Œ ë˜ì—ˆê³   S3 ë²„í‚·ì´ ACLì„ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ì„¤ì •ë˜ì–´ ìˆê±°ë‚˜, ë²„í‚· ì •ì±…ì´ ì ì ˆíˆ ì„¤ì •ëœ ê²½ìš° ACL ì—†ì´ë„ íŒŒì¼ ì—…ë¡œë“œê°€ ì •ìƒì ìœ¼ë¡œ ì§„í–‰ë¨!

<br>

##  3. ì‚¬ìš©ì ìƒì„±

- AWS console > IAM > ì•¡ì„¸ìŠ¤ ê´€ë¦¬ > ì‚¬ìš©ì > ì‚¬ìš©ì ì¶”ê°€ í´ë¦­

<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/471df8a9-405e-4ae3-9363-605c19d809fe"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/471df8a9-405e-4ae3-9363-605c19d809fe"  alt="1"  loading="lazy"></a>

- ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ê³  ë‹¤ìŒì„ í´ë¦­

<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/2555b800-b1e2-4b64-9b72-3633f9aff96a"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/2555b800-b1e2-4b64-9b72-3633f9aff96a"  alt="1"  loading="lazy"></a>

<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/372bba3d-bb11-4759-9dcd-c062a7c1e634"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/372bba3d-bb11-4759-9dcd-c062a7c1e634"  alt="1"  loading="lazy"></a>

- ì§ì ‘ ì •ì±… ì—°ê²°ì„ ì„ íƒí•˜ê³  AmazonS3FullAccessë¥¼ ì„ íƒ í›„ ë‹¤ìŒì„ í´ë¦­í•˜ê³  ì‚¬ìš©ì ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‚¬ìš©ìê°€ ìƒì„±ë¨!

<br>

## 4. ì•¡ì„¸ìŠ¤ í‚¤ ìƒì„±

- ì™¸ë¶€ì—ì„œ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ ì‚¬ìš©ìì˜ ì•¡ì„¸ìŠ¤ í‚¤ë¥¼ ë§Œë“¤ì–´ ì£¼ì–´ì•¼ í•¨.

- AWS console > IAM > ì•¡ì„¸ìŠ¤ ê´€ë¦¬ì > ì‚¬ìš©ì > ìƒì„±í•œ ì‚¬ìš©ì ì´ë¦„ í´ë¦­ > ë³´ì•ˆ ìê²© ì¦ëª… > ì•¡ì„¸ìŠ¤ í‚¤ ë§Œë“¤ê¸° í´ë¦­!

- ì•„ë¬´ê±°ë‚˜ í´ë¦­í•˜ê³  ë‹¤ìŒì„ í´ë¦­ ( í´ë¦­í•˜ë©´ ì•¡ì„¸ìŠ¤ í‚¤ ì‚¬ìš© ì‚¬ë¡€ì™€ ëŒ€ì•ˆì„ í•˜ë‹¨ì— ë„ì›Œì£¼ëŠ” ê¸°ëŠ¥ë§Œ í•˜ê¸° ë•Œë¬¸ì— ë¬´ì—‡ì„ ê³¨ë¼ë„ ìƒê´€ì—†ìŒ)

- íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  ì•¡ì„¸ìŠ¤ í‚¤ ë§Œë“¤ê¸° í´ë¦­!

- ì•¡ì„¸ìŠ¤ í‚¤ ìƒì„± ì™„ë£Œ í™”ë©´ì—ì„œ ìƒì„±ëœ ê³µê°œí‚¤ì™€ ë¹„ë°€í‚¤ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ (í•´ë‹¹ í™”ë©´ì´ ì•„ë‹ˆë©´ ë¹„ë°€ ì•¡ì„¸ìŠ¤ í‚¤ë¥¼ ë³¼ ìˆ˜ ì—†ê¸° ë–„ë¬¸ì— .csv íŒŒì¼ë¡œ ë°›ì•„ë‘ëŠ” ê²ƒì´ ì¢‹ìŒ)


<br>

## 5. ìŠ¤í”„ë§ ì—°ë™

```java
implementation 'org.springframework.cloud:spring-cloud-starter-aws:2.2.6.RELEASE'
```

- build.gradleì— ì˜ì¡´ì„± ì¶”ê°€

```java
cloud:  
  aws:  
    credentials:  
      accessKey: ${AWS_ACCESS_KEY}  
      secretKey: ${AWS_SECRET_KEY}  
  
    region:  
      static: ${AWS_REGION}  
      auto: false  
  
 stack:  
      auto: false  
  
 s3:  
      bucket: ${AWS_BUCKET_NAME}
```

- .env íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ í™˜ê²½ë³€ìˆ˜ì— ì¶”ê°€í•¨

- `stack.auto : false`  : EC2ì—ì„œ Spring Cloud í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ê¸°ë³¸ìœ¼ë¡œ CloudFormation êµ¬ì„±ì„ ì‹œì‘í•˜ê¸° ë•Œë¬¸ì— ì„¤ì •í•œ CloudFormationì´ ì—†ìœ¼ë©´ í”„ë¡œì íŠ¸ ì‹¤í–‰ì´ ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í•´ë‹¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ falseë¡œ ì„¤ì •.

- **S3Config.java**

```java
@Configuration  
public class S3Config {  
  
    @Value("${cloud.aws.credentials.accesskey}")  
    private String accessKey;  
    @Value("${cloud.aws.credentials.secretkey}")  
    private String secretKey;  
    @Value("${cloud.aws.region.static}")  
    private String region;  
  
    @Bean  
  public AmazonS3Client amazonS3Client() {  
        BasicAWSCredentials awsCredentials= new BasicAWSCredentials(accessKey, secretKey);  
        return (AmazonS3Client) AmazonS3ClientBuilder.standard()  
                .withRegion(region)  
                .withCredentials(new AWSStaticCredentialsProvider(awsCredentials))  
                .build();  
    }  
  
}
```

## 6. Postman API í…ŒìŠ¤íŠ¸

- muitipart ë°ì´í„°ë¥¼ ì „ì†¡í•´ì•¼ í•˜ë¯€ë¡œ Body ìœ í˜•ì„ form-dataë¡œ ì„ íƒí•˜ê³  KEY ì†ì„±ì„ Fileì„ ì„ íƒí•¨.

<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/e47168eb-957a-4c5b-8534-5ca6c445d60e"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/e47168eb-957a-4c5b-8534-5ca6c445d60e"  alt="1"  loading="lazy"></a>


- s3ì—ì„œ ì •ìƒì ìœ¼ë¡œ ì´ë¯¸ì§€ê°€ ì €ì¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ.

<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521//0e660669-c41b-4d73-8513-81c4ee207974"  class="popup img-link"><img  src="https://github.com/user-attachments/assets//0e660669-c41b-4d73-8513-81c4ee207974"  alt="1"  loading="lazy"></a>

- DBì—ì„œ ì •ìƒì ìœ¼ë¡œ ì´ë¯¸ì§€ê°€ ì €ì¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ.
<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/f121093e-f408-4b5f-8f7a-a7dab3c9a7cb"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/f121093e-f408-4b5f-8f7a-a7dab3c9a7cb"  alt="1"  loading="lazy"></a>


# ì½”ë“œ ë¶„ì„

```java
@Getter  
@Setter  
@NoArgsConstructor  
@Entity  
@Table(name = "files")  
public class File extends TimeStamped {  
  
    @Id  
 @GeneratedValue(strategy = GenerationType.IDENTITY)  
    private Long id;  
    private String fileName;  
    private String fileUrl;  
    private String fileType;  
    private long fileSize;  
  
    @ManyToOne(fetch = FetchType.LAZY)  
    @JoinColumn(name = "marker_id")  
    private Marker marker;  
  
    public File(String fileName, String fileUrl, String fileType, long fileSize) {  
        this.fileName = fileName;  
        this.fileUrl = fileUrl;  
        this.fileType = fileType;  
        this.fileSize = fileSize;  
    }  
  
}
```

- íŒŒì¼ ì—”í‹°í‹°ëŠ” id, fileName, fileUrl, fileType, fileSizeë¥¼ í•„ë“œë¡œ ì„ ì–¸í•˜ê³  markerIdì™€ ì—°ê´€ê´€ê³„ë¥¼ ë§ºìŒ. fileIdê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ê³  ëª‡ ë²ˆì˜ markerì™€ ì—°ê²°ë˜ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•¨


```java
@Slf4j  
@Service  
@Transactional  
@RequiredArgsConstructor  
public class FileService {  
  
    private static final long MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB  
  private static final long MAX_VIDEO_SIZE = 200 * 1024 * 1024; // 200MB  
  
  @Value("${cloud.aws.s3.bucket}")  
    private String bucket;  // íŒŒì¼ì´ ì €ì¥ë  S3 ë²„í‚·ì˜ ì´ë¦„. ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œí¼í‹°ì—ì„œ ì£¼ì…ë¨
    private final AmazonS3 amazonS3; //S3ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” AWS S3 í´ë¼ì´ì–¸íŠ¸
    private final FileRepository fileRepository;  //íŒŒì¼ ë©”íƒ€ë°ì´í„°ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” JPA ë ˆí¬
  
    // ì—¬ëŸ¬ íŒŒì¼ì„ S3ì— ì—…ë¡œë“œí•˜ê³  íŒŒì¼ ë©”íƒ€ë°ì´í„°ë¥¼ DBì— ì €ì¥í•˜ëŠ” ë©”ì„œë“œ
    public List<File> uploadFile(List<MultipartFile> multipartFiles) {  
  
        List<File> fileEntities = new ArrayList<>();  
  
        multipartFiles.forEach(file -> {  
            String originalFilename = file.getOriginalFilename();  
            String fileName = createFileName(originalFilename);  
            String extension = getFileExtension(originalFilename);  
  
            ObjectMetadata objectMetadata = new ObjectMetadata();  
            validateFileSize(file.getSize(), extension);  
            objectMetadata.setContentLength(file.getSize());  
            objectMetadata.setContentType(file.getContentType());  
  
            try (InputStream inputStream = file.getInputStream()) { 
                // amazonS3.putObject()ë¥¼ í†µí•´ íŒŒì¼ì„ S3ì— ì—…ë¡œë“œ 
                amazonS3.putObject(new PutObjectRequest(bucket, fileName, inputStream, objectMetadata));  
            } catch (IOException e) {  
                throw new CustomException(ErrorCode.PUT_OBJECT_EXCEPTION);  
            }  
  
            String fileUrl = amazonS3.getUrl(bucket, fileName).toString();  
  
            // íŒŒì¼ ì •ë³´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥  
  File fileEntity = new File(fileName, fileUrl, file.getContentType(), file.getSize());  
            fileRepository.save(fileEntity);  
            // í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ê³  ë°˜í™˜
            fileEntities.add(fileEntity);  
        });  
  
        return fileEntities;  
    }  
  
    // ê³ ìœ í•œ íŒŒì¼ ì´ë¦„ ìƒì„±í•˜ëŠ” ë©”ì„œë“œ
    private String createFileName(String fileName) {  
        // fileNameì´ ì›ë˜ íŒŒì¼ ì´ë¦„
        return UUID.randomUUID().toString().concat(getFileExtension(fileName));  
    }  
  
    // ì›ë˜ íŒŒì¼ ì´ë¦„ì—ì„œ íŒŒì¼ í™•ì¥ìë¥¼ ì¶”ì¶œ
    private String getFileExtension(String fileName) {  
          
        try {  
            validateImageFileExtension(fileName);  
            return fileName.substring(fileName.lastIndexOf("."));  
        } catch (StringIndexOutOfBoundsException e) {  
            throw new CustomException(ErrorCode.FILE_NAME_INVALID);  
        }  
          
    }  
    
    //íŒŒì¼ í™•ì¥ìê°€ í—ˆìš©ëœ ëª©ë¡ì— ìˆëŠ”ì§€ ê²€ì¦í•¨.
    private void validateImageFileExtension(String filename) {  
  
        int lastDotIndex = filename.lastIndexOf(".");  
  
        if (lastDotIndex == -1) {  
            throw new CustomException(ErrorCode.EXTENSION_IS_EMPTY);  
        }  
  
        String extension = filename.substring(lastDotIndex + 1).toLowerCase();  
        List<String> allowedExtensionList = Arrays.asList("jpg", "jpeg", "png", "avi", "mp4", "gif");  
  
        if (!allowedExtensionList.contains(extension)) {  
            throw new CustomException(ErrorCode.EXTENSION_INVALID);  
        }  
  
    }  
  
    // íŒŒì¼ í¬ê¸° ê²€ì¦í•˜ëŠ” ë©”ì„œë“œ
    private void validateFileSize(long size, String extension) {  
  
        if (isImageFile(extension) && size > MAX_IMAGE_SIZE) {  
            throw new IllegalArgumentException("ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");  
        } else if (isVideoFile(extension) && size > MAX_VIDEO_SIZE) {  
            throw new IllegalArgumentException("ë¹„ë””ì˜¤ íŒŒì¼ í¬ê¸°ëŠ” 200MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");  
        }  
  
    }  
  
    // íŒŒì¼ í™•ì¥ìê°€ ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
    private boolean isImageFile(String extension) {  
  
        return extension.equals("jpeg") || extension.equals("jpg") || extension.equals("png");  
    }  
  
    // íŒŒì¼ í™•ì¥ìê°€ ë¹„ë””ì˜¤ íŒŒì¼ì¸ì§€ í™•ì¸
       private boolean isVideoFile(String extension) {  
  
        return extension.equals("mp4") || extension.equals("avi") || extension.equals("gif");  
    }  
  
    public void deleteFile(String fileUrl) {  
        // íŒŒì¼ URLë¡œ S3ì—ì„œ ì‚­ì œ  
        String key = getKeyFromFileAddress(fileUrl);  
  
        try {  
            amazonS3.deleteObject(new DeleteObjectRequest(bucket, key));  
            // íŒŒì¼ URLë¡œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚­ì œ  
            fileRepository.deleteByFileUrl(fileUrl);  
        } catch (Exception e) {  
            log.error("Error occurred while deleting the file", e);  
            throw new CustomException(ErrorCode.IO_EXCEPTION_ON_IMAGE_DELETE);  
        }  
  
    }  
  
    // íŒŒì¼ URLì—ì„œ S3í‚¤ë¥¼ ì¶”ì¶œ
    private String getKeyFromFileAddress(String fileAddress) {  
  
        try {  
            // urlì„ URL ê°ì²´ë¡œ ë³€í™˜
            URL url = new URL(fileAddress);  
            String decodingKey = URLDecoder.decode(url.getPath(), StandardCharsets.UTF_8);  
            return decodingKey.substring(1); // ë§¨ ì•ì˜ '/' ì œê±°í•˜ì—¬ S3í‚¤ë¥¼ ì–»ìŒ
  } catch (MalformedURLException e) {  
            e.printStackTrace();  
            throw new CustomException(ErrorCode.IO_EXCEPTION_ON_IMAGE_DELETE);  
        }  
  
    }  
  
}
```


- ì›ë˜ FileServiceì—ì„œ ìƒê¸°ì˜ ë‚´ìš©ì„ ì²˜ë¦¬í•˜ê³  MarkerControllerì™€ MarkerServiceì—ì„œ í•˜ê¸°ì˜ ë‚´ìš©ì„ ì²˜ë¦¬í•˜ë ¤ê³  í•¨. 

- ì¶”ê°€ë¡œ íŒŒì¼ ì €ì¥ì€ MarkerResponseDtoë¡œ ë°˜í™˜í•˜ë ¤ê³  í•¨. ì™œëƒí•˜ë©´ ìœ„ë„, ê²½ë„, ê¸€ ë‚´ìš© ë“±ì˜ ë‚´ìš©ë„ í”„ë¡ íŠ¸ì— ê°™ì´ ë³´ë‚´ê¸° ìœ„í•¨.


```java
// íŒŒì¼ ì €ì¥  
@PostMapping("/markers/files")  
public ResponseEntity<CommonResponseDto<List<MarkerResponseDto>>> uploadFile(@RequestPart(value = "file", required = false) List<MultipartFile> multipartFiles) {  
    List<MarkerResponseDto> responseDto = markerFileService.uploadFiles(multipartFiles);  
  
    return new ResponseEntity<>(new CommonResponseDto<>(201, "íŒŒì¼ ì—…ë¡œë“œì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤. ğŸ‰", responseDto), HttpStatus.CREATED);  
}  
  
// íŒŒì¼ ì‚­ì œ  
@DeleteMapping("/markers/{markerId}/files")  
public ResponseEntity<CommonResponseDto<String>> deleteFile(  @PathVariable Long markerId,  
                                                              @RequestParam String fileUrl){  
    markerFileService.deleteFile(markerId, fileUrl);  
  
    return ResponseEntity.ok(new CommonResponseDto<>(200, "íŒŒì¼ ì‚­ì œì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤. ğŸ‰", null));  
}
```

<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/c19e787d-ef18-4469-bbdf-471f95f3317e"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/c19e787d-ef18-4469-bbdf-471f95f3317e"  alt="1"  loading="lazy"></a>

- í•´ë‹¹ ì˜¤ë¥˜ ë°œìƒ : ìˆœí™˜ ì°¸ì¡°(circular reference) ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ MarkerServiceì™€ FileService ê°„ì˜ ì˜ì¡´ì„±ì„ ëŠì–´ì•¼ í•¨. ìˆœí™˜ ì°¸ì¡°ëŠ” ë‘ ê°œ ì´ìƒì˜ ë¹ˆì´ ì„œë¡œë¥¼ ì°¸ì¡°í•  ë•Œ ë°œìƒ.

- ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ MarkerSeviceì—ì„œ íŒŒì¼ ê´€ë ¨ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë¡œì§ì„ ë³„ë„ì˜ ì„œë¹„ìŠ¤ë¡œ ë¶„ë¦¬í•¨ > `MarkerFileService`

- `MarkerFileService`ì—ì„œ uploadFile ì²˜ë¦¬ë‘ í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ë¥¼ MarkerResponseDtoë¡œ ë°˜í™˜ë˜ê²Œ ìˆ˜ì •í•´ì„œ í•´ê²°í•¨.


<br>

# S3 ê¶Œí•œ ì •ì±… ìˆ˜ì •

- AmazonS3 > ë²„í‚· > [ë²„í‚·name] > ì— ë“¤ì–´ì™€ì„œ ì†ì„± ê°ì²´ URLì— ì ‘ì†í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ëœ¸

<a  href="https://github.com/LeeNaYoung240/LeeNaYoung240.github.io/assets/107848521/a71b3d03-a171-4f9e-b1f1-e3d3f53fe069"  class="popup img-link"><img  src="https://github.com/user-attachments/assets/a71b3d03-a171-4f9e-b1f1-e3d3f53fe069"  alt="1"  loading="lazy"></a>

```
This XML file does not appear to have any style information associated with it. The document tree is shown below.  
<Error>  
<script/>  
<script/>  
<script/>  
<Code>AccessDenied</Code>  
<Message>Access Denied</Message>  
<RequestId>9F6RK80ZW51YE3F2</RequestId>  
<HostId>0L7lglmFWQNleQGjCw5NF9itdEkjhzS+itwhMeNxNpyNHKshc1GmwUthSaU/w3IyCFGrDJMlzDU=</HostId>  
</Error>
```


- AmazonS3 > ë²„í‚· > ê¶Œí•œì—ì„œ **ë²„í‚· ì •ì±…** ìˆ˜ì •

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AddPerm",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::[ë²„í‚·name]/*"
        }
    ]
}
```
- ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ë©´ ê°ì²´ URLì— ì ‘ì†í•  ë•Œ ì •ìƒì ìœ¼ë¡œ ì´ë¯¸ì§€ê°€ ëœ¸!